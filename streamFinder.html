
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://mrmufflon.github.io/Leaflet.Coordinates/dist/Leaflet.Coordinates-0.1.3.css"/>
<script src="https://unpkg.com/leaflet@1.0.1/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://azavea.github.io/Leaflet.zoomdisplay/css/leaflet.zoomdisplay.css"/>
<script src="https://unpkg.com/esri-leaflet@2.0.8"></script>
<script src="https://azavea.github.io/Leaflet.zoomdisplay/js/leaflet.zoomdisplay.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.3/proj4.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.1/proj4leaflet.min.js"></script>
<script src="https://mrmufflon.github.io/Leaflet.Coordinates/dist/Leaflet.Coordinates-0.1.3.min.js"></script>
<script src="https://www.weather.gov/source/aprfc/js/esri2geojson.js"></script>




<style>
.maincontainer {
    width: 900px;
    background: grey;
    margin: auto;
    padding: 10px;
}

.center{
    text-align: center;
}


.map {
    height: 300px;
    width: 400px;
}

#mapid {
    height   : 700px;
    width    : 100%;
    margin   : 0px;
    padding  : 0px;
    overflow : hidden;
},

</style>
<script>



$('#loading-image').bind('ajaxStart', function(){
    jQuery("#loading-image").css('visibility', 'visible');
}).bind('ajaxStop', function(){
    jQuery("#loading-image").css('visibility', 'hidden');
});


var layersByName = {};



function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
}




function findStreamByName(name,matchType,map,zoomMap){

    $.each(layersByName,function(k,v){
        map.removeLayer(v);
        mapControl.removeLayer(v);
    });
    jQuery("#loading-image").css('visibility', 'visible');

    var corner1 = L.latLng(50, -170),
        corner2 = L.latLng(75, -132),
        bounds = L.latLngBounds(corner1, corner2);

    var nhdUrl = 'https://services.nationalmap.gov/arcgis/rest/services/nhd/mapserver/9/query';
    var streamURL = 'https://txgeo.usgs.gov/arcgis/rest/services/Streamer/HydroData/MapServer/1/query';
    var whereStatement = 'upper(Name) like upper(\'%'+name+'%\')';
    if(matchType == 'exact') whereStatement = 'upper(Name) = upper(\''+name+'\')';
    var params = {
        //where: 'upper(GNIS_NAME) like upper(\'%'+name+'%\')',
        where: whereStatement,
        geometry:'esriGeometryEnvelope&geometry='+bounds.getEast()+','+bounds.getSouth()+','+bounds.getWest()+','+bounds.getNorth(),
        geometryType:'esriGeometryEnvelope',
        inSR:4326,
        spatialRel:'esriSpatialRelIntersects',
        returnGeometry:true,
        returnTrueCurves:false,
        geometryPrecision:1,
        outSR:3857,
        returnIdsOnly:false,
        returnCountOnly:true,
        returnZ:false,
        returnM:false,
        returnDistinctValues:false,
        //f:'geojson'
        f:'json'
        }

    $.ajax({
        type: "GET",
        url: streamURL,
        data: params,
        dataType: "json",
        success: function (data) {
            $('#foundRivers').html('<strong> River Reaches Found: '+data.count+' <font color="green"> Shown in Green on the map below</font> </strong>');
            $( '#foundRivers').show();
        }
    });

    params.returnCountOnly = false;
    var flowLines = {"type":"FeatureCollection",
                        "features":[],
                        "crs":{
                            "type": "name",
                            "properties": {
                                "name": "EPSG:3857"
                            }
                        }
                    }

    var myStyle = {
        "color": "green",
        "weight": 5,
    };
    if(typeof(layersByName['streamNameLayer'] ) != 'undefined'){
        map.removeLayer(layersByName['streamNameLayer']);
        mapControl.removeLayer(layersByName['streamNameLayer']);
    }
     $.ajax({
            type: "GET",
            url: streamURL,
            data: params,
            dataType: "json",
            success: function (data) {
                if(data.features.length==0) return true;
                $.each(data.features,function(){
                    var geoJSON = arcgisToGeoJSON(this);
                    flowLines.features.push(geoJSON);
                });
                var markers = L.Proj.geoJson(flowLines, {
                    style: myStyle,
                    onEachFeature: function (feature, layer) {
                        var popupcontent = "";
                        $.each(feature.properties,function(k,v){
                            popupcontent = popupcontent + "<span style='font-weight:bold'>"+k+": </span>"+v+"<br>";
                        });
                        layer.bindPopup(popupcontent);

                        }
                });
                map.addLayer(markers);
                layersByName['streamNameLayer'] = markers;
                var group = new L.featureGroup(markers);

                var layers = markers.getLayers();
                mapControl.addOverlay(markers, "Named Stream Reaches");
                console.log(sZoom);
                if(!zoomMap){
                    map.fitBounds(markers.getBounds());
                    map.setZoom(zoom);
                }

            },
            error: function (request, status, errorThrown) {
                console.log(status);
            },
            complete: function(){
                    jQuery("#loading-image").css('visibility', 'hidden');
            }
        });
}

function getHUC(lat,lon){

    var dest = new proj4.Proj('EPSG:3857');
    var point = proj4(dest,[lon,lat]);
    var huc = '';

    var ht = 315*100;     //imageDisplay x 100 = each pixel 100 meters
    var wd = 1370*100;    //imageDisplay x 100 = each pixel 100 meters
    var results = {};

    var params = {
        tolerance : 0,
        returnGeometry : true,
        geometryType : 'esriGeometryPoint',
        mapExtent : (point[0]-wd)+','+(point[1]-ht)+','+(point[0]+wd)+','+(point[1]+ht),
        imageDisplay : '1370,315,1',
        f : 'json',
        sr : 102100,
        layers: 'all:4,5,6',
        geometry: '{ "x" : '+point[0]+', "y" : '+point[1]+' }'
    };
    var flowLines = {"type":"FeatureCollection",
                        "features":[],
                        "crs":{
                            "type": "name",
                            "properties": {
                                "name": "EPSG:3857"
                            }
                        }
                    }
    var myStyle = {
        "color": "green",
        "weight": 2,
        "opacity": 0.5
    };
    if(typeof(layersByName['wbdLayer'] ) != 'undefined'){
        map.removeLayer(layersByName['wbdLayer']);
    }

    var showInfo = ['AREASQKM','NAME','HUC10','HUC6','HUC8'];
     $.ajax({
            type: "GET",
            url: "https://services.nationalmap.gov/arcgis/rest/services/wbd/MapServer/identify",
            data: params,
            contentType: "application/json; charset=utf-8",
            headers : {'Content-Type' : 'application/x-www-form-urlencoded; charset=UTF-8'},
            dataType: "json",
            success: function (data) {
                $.each(data.results,function(){
                    var geoJSON = arcgisToGeoJSON(this);
                    flowLines.features.push(geoJSON);
                });

                var markers = L.Proj.geoJson(flowLines, {
                    style: myStyle,
                    onEachFeature: function (feature, layer) {
                        var popupcontent = "<h4>Information from  National Map WBD</h4>";
                        var secondaryContent = ""
                        $.each(feature.properties,function(k,v){
                            if(showInfo.indexOf(k)>=0){
                                popupcontent = popupcontent + "<span style='font-weight:bold'>"+k+": </span>"+v+"<br>";
                            }
                            else{
                                secondaryContent = secondaryContent + "<span class='moreInfo' style='font-weight:italic;display:none'>"+k+": "+v+"<br></span>";
                            }
                        });
                        popupcontent = popupcontent + secondaryContent+'<button onclick="$(\'.moreInfo\').show();">Click for More Info</button>';
                        layer.bindPopup(popupcontent);
                        }
                });
                map.addLayer(markers);
                mapControl.addOverlay(markers, "HUC Basins");

                layersByName['wbdLayer'] = markers;
                $.each(data.results,function(){
                    huc = (this.layerId-1)*2;
                    $('#siteInfo').append(this.layerName+': '+this.value+' '+this.attributes['HUC'+huc]+'<br>');
                    results[huc] = this.layerName+': '+this.value+' '+this.attributes['HUC'+huc];
                });
                if(typeof(layersByName['reachLayer'] ) != 'undefined'){
                    layersByName['reachLayer'].bringToFront();
                }
            },
            error: function (request, status, errorThrown) {
                console.log(status);
            }
        });
    return results;
}


function streamer(lat,lon){

    var dest = new proj4.Proj('EPSG:3857');
    var point = proj4(dest,[lon,lat]);

    var ht = 315*100;     //imageDisplay x 100 = each pixel 100 meters
    var wd = 1370*100;    //imageDisplay x 100 = each pixel 100 meters

    var params = {
        tolerance : 1,
        returnGeometry : true,
        geometryType : 'esriGeometryPoint',
        mapExtent : (point[0]-wd)+','+(point[1]-ht)+','+(point[0]+wd)+','+(point[1]+ht),
        imageDisplay : '1370,315,1',
        f : 'json',
        sr : 102100,
        layers: 'all:1',
        //layers: 'all:15',
        geometry: '{ "x" : '+point[0]+', "y" : '+point[1]+' }'
    };

    var flowLines = {"type":"FeatureCollection",
                        "features":[],
                        "crs":{
                            "type": "name",
                            "properties": {
                                "name": "EPSG:3857"
                            }
                        }
                    }
    var myStyle = {
        "color": "#00008B",
        "weight": 5,
        "opacity": 0.65
    };
    if(typeof(layersByName['reachLayer'] ) != 'undefined'){
        map.removeLayer(layersByName['reachLayer']);
    }
    var i;
    var foundOne = false;
    var showInfo = ['Stream_ID','Name','HUC4','ExitWB','SHAPE_Length'];
    var markers;
    var layer;
    for(i =1;i<50;i++){
        params.tolerance = i;
        $.ajax({
            type: "GET",
            url: "https://txgeo.usgs.gov/arcgis/rest/services/Streamer/HydroData/MapServer/identify",
            data: params,
            contentType: "application/json; charset=utf-8",
            headers : {'Content-Type' : 'application/x-www-form-urlencoded; charset=UTF-8'},
            dataType: "json",
            async:false,
            success: function (data) {
                if(data.results.length > 0) {
                    foundOne = true;
                    console.log('Found a stream '+i);
                    $.each(data.results,function(){
                        var geoJSON = arcgisToGeoJSON(this);
                        flowLines.features.push(geoJSON);
                    });
                    markers = L.Proj.geoJson(flowLines, {
                        style: myStyle,
                        onEachFeature: function (feature, layer) {
                            var popupcontent = "<h4>Information from  1:1,000,000 scale USGS hydrographic base map.</h4>";
                            var secondaryContent = ""
                            $.each(feature.properties,function(k,v){
                                if(showInfo.indexOf(k)>=0){
                                    popupcontent = popupcontent + "<span style='font-weight:bold'>"+k+": </span>"+v+"<br>";
                                }
                                else{
                                    secondaryContent = secondaryContent + "<span class='moreInfo' style='font-weight:italic;display:none'>"+k+": "+v+"<br></span>";
                                }
                            });
                            popupcontent = popupcontent + secondaryContent+'<button onclick="$(\'.moreInfo\').show();">Click for More Info</button>';
                            layer.bindPopup(popupcontent);
                            layer.on('add', function (e) {
                                this.openPopup();
                            });
                        }
                    });
                    map.addLayer(markers);
                    mapControl.addOverlay(markers, "Selected Stream Reach");

                    layersByName['reachLayer'] = markers;
                    var layers = markers.getLayers();
                }
            },
            error: function (request, status, errorThrown) {
                console.log(status);
            }


        });

        if(foundOne) return markers;
     }
}



</script>
    <div class = 'center'>
        <h3>Search for your River or Watershed in Alaska</h3>
        <a href = "" id="directLink">Link to share map (right click 'Copy Link Address')</a><br>
        <div id="loading"></div>
        <div id="loading-image" style="width:69px;height:89px;border:1px solid black;position:relative;top:10%;left:50%;padding:2px;border:10px"><img src='https://www.w3schools.com/jquery/demo_wait.gif' width="64" height="64" /><br>Loading..</div>
        Search for River:<input type="text" id="riverSearch"><button type="button" id="buttonSearch" onclick ="findStreamByName($('#riverSearch').val(),$('input[name=searchType]:checked').val(),map,false);">Find Rivers</button><br><span id="foundRivers"></span>
        <br>
        <input type="radio" name="searchType" value="includes" checked>Includes<input type="radio" name="searchType" value="exact">Exact Match<br>
        <i>Text above is matched to river names in the USGS 1:1,000,000 river dataset.  Check and see how many Fish or Beaver Creeks exist in Alaska!</i><br>
        <i>Use the cross hairs to click a point and find the nearest:<br>
            <input type="radio" name="type" value="river" checked="checked"> River Reach<br>
            <input type="radio" name="type" value="huc"> HUC basins<br>
        <button type="button" onclick ="$.each(layersByName,function(k,v){console.log(v);map.removeLayer(v);mapControl.removeLayer(v);});$( '#foundRivers' ).hide();">Clear Map</button>
    </div>
    Basemap data and search capabilities provided by the USGS Streamer team.  For more information visit: <a href="https://txgeo.usgs.gov/DSS/streamer/web/">https://txgeo.usgs.gov/DSS/streamer/web/</a>
    <div class="maincontainer">
        <div id="mapid"></div>
    </div>
 <script>

$("#loading-image").css("visibility", "hidden");


var nhdLargeFlow = L.tileLayer('https://services.nationalmap.gov/arcgis/services/nhd/MapServer/WMSServer?',{
    layers : '3',
    version : '1.3.0'
    });

var esriTopo = L.esri.basemapLayer("Topographic");
var usgsTopo =   L.esri.tiledMapLayer({
    url: "https://services.arcgisonline.com/ArcGIS/rest/services/USA_Topo_Maps/MapServer"
  });


var worldTerrain  =  L.tileLayer( "https://server.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer/tile/{z}/{y}/{x}" );
var oceanLayer    =  L.tileLayer( "https://txgeo.usgs.gov/arcgis/rest/services/Mapping/Ocean/MapServer/tile/{z}/{y}/{x}",{"maxNativeZoom":11} );
var hydroTerrain  =  L.tileLayer( "https://txgeo.usgs.gov/arcgis/rest/services/Mapping/HydroBaseMapForTerrain/MapServer/tile/{z}/{y}/{x}",{"maxNativeZoom":11} );
var hydroMask     =  L.tileLayer( "https://txgeo.usgs.gov/arcgis/rest/services/Mapping/Mask/MapServer/tile/{z}/{y}/{x}", {"opacity":0.2,"maxNativeZoom":11} );
var Esri_WorldImagery = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
});

var hydroBase = L.layerGroup([worldTerrain, hydroTerrain, hydroMask]);

var lat = getParameterByName('lat');
if(lat == null){
    lat = 65;
}

var lon = getParameterByName('lon');
if(lon == null){
    lon = -150;
}

var zoom = getParameterByName('zoom');
var sZoom = true;
if(zoom == null){
    zoom = 5;
    sZoom = false;
}

// create map with ESRI World Terrain Base, Streamer Ocean, Streamer HydroBaseMapForTerrain, and Streamer Mask layers
map = new L.Map( "mapid", {
    "minZoom" : 4,
   // "maxZoom" : 11,
    "layers"  : [Esri_WorldImagery,esriTopo,usgsTopo,hydroBase],
    "center"  : new L.LatLng(lat,lon),
    "zoom"    : zoom,
    "attributionControl" : false
});

var baseMaps = {
    "World Imagery" : Esri_WorldImagery,
    "Topography" : esriTopo,
    "USGS Maps" : usgsTopo,
    "Hydrography" : hydroBase,
};

var mapControl = L.control.layers(baseMaps,null).addTo(map);
L.control.coordinates(
    {labelTemplateLat:"Lat: {y}",
	labelTemplateLng:"Lon: {x}"}).addTo(map);


$('.leaflet-container').css('cursor','crosshair');

function checkVisible(elm) {
  var rect = elm.getBoundingClientRect();
  var viewHeight = Math.max(document.documentElement.clientHeight, window.innerHeight);
  return !(rect.bottom < 0 || rect.top - viewHeight >= 0);
}

var river = getParameterByName('riverSearch');
var getExact = getParameterByName('exact');
if(river != null){
    $('#riverSearch').val(river);
    if(river.length > 0){
        if(getExact != null){
            findStreamByName(river,'exact',map,true);
        }
        else{
            findStreamByName(river,'includes',map,true);
        }
    }
}

map.on('zoomend', function() {
    var link = "?lat="+map.getCenter().lat.toFixed(5)+"&lon="+map.getCenter().lng.toFixed(5)+"&zoom="+map.getZoom()+"&riverSearch="+$('#riverSearch').val();
    $("#directLink").attr("href", link);
});

map.on('dragend', function() {
    var link = "?lat="+map.getCenter().lat.toFixed(5)+"&lon="+map.getCenter().lng.toFixed(5)+"&zoom="+map.getZoom()+"&riverSearch="+$('#riverSearch').val();
    $("#directLink").attr("href", link);
});




map.on('click', function(e) {
    jQuery("#loading-image").css('visibility', 'visible');

    if($('input[name="type"]:checked').val() == 'huc') {
            getHUC(e.latlng.lat,e.latlng.lng);
            if(typeof(layersByName['pointLayer'] ) != 'undefined'){
                map.removeLayer(layersByName['pointLayer']);
            }
        }
    else{
        streamer(e.latlng.lat,e.latlng.lng);
        layersByName['reachLayer'].openPopup();
    }
    jQuery("#loading-image").css('visibility', 'hidden');

});


var input = document.getElementById("riverSearch");
// Execute a function when the user releases a key on the keyboard
input.addEventListener("keyup", function(event) {
  // Cancel the default action, if needed
  event.preventDefault();
  // Number 13 is the "Enter" key on the keyboard
  if (event.keyCode === 13) {
    // Trigger the button element with a click
    document.getElementById("buttonSearch").click();
  }
});
</script>

